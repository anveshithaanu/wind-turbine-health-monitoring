<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="logo-icon">‚ö°</span>
      <span class="logo-text">Wind Turbine</span>
    </div>
    <nav class="sidebar-nav">
      <a class="nav-item" [class.active]="currentPage === 'dashboard'" (click)="navigateToPage('dashboard')">
        <span class="nav-icon">üìä</span>
        <span>Dashboard</span>
      </a>
      <a class="nav-item" [class.active]="currentPage === 'alerts'" (click)="navigateToPage('alerts')">
        <span class="nav-icon">üîî</span>
        <span>Alerts</span>
      </a>
      <a class="nav-item" [class.active]="currentPage === 'analytics'" (click)="navigateToPage('analytics')">
        <span class="nav-icon">üìà</span>
        <span>Analytics</span>
      </a>
      <a class="nav-item" [class.active]="currentPage === 'turbines'" (click)="navigateToPage('turbines')">
        <span class="nav-icon">üîß</span>
        <span>Turbines</span>
      </a>
    </nav>
  </div>

  <div class="main-content">
    <div class="content-header">
      <div>
        <h1>Wind Turbine Health Monitor</h1>
        <p>Real-time turbine status across your fleet</p>
      </div>
      <button class="theme-btn" (click)="toggleTheme()">
        <span *ngIf="isDarkTheme">üåô</span>
        <span *ngIf="!isDarkTheme">‚òÄÔ∏è</span>
        <span>{{ isDarkTheme ? 'Dark' : 'Light' }}</span>
      </button>
    </div>

    <div *ngIf="currentPage === 'dashboard'" class="dashboard">
      <div class="section">
        <h3>Where to look?</h3>
        <p>Choose region and farm to narrow results</p>
        <div class="filters">
          <div class="filter-group">
            <label>Region</label>
            <select class="filter-select" [(ngModel)]="dashboardFilters.region" (change)="applyFilters()">
              <option value="">All regions</option>
              <option *ngFor="let region of getRegions()" [value]="region">{{ region }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Farm</label>
            <select class="filter-select" [(ngModel)]="dashboardFilters.farm" (change)="applyFilters()">
              <option value="">All farms</option>
              <option *ngFor="let farm of farms" [value]="farm.name">{{ farm.name }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>At a glance</h3>
        <div class="stats-grid">
          <div class="stat-card healthy">
            <div class="stat-value">{{ getHealthyCount() }}</div>
            <div class="stat-label">Healthy</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value">{{ getWarningCount() }}</div>
            <div class="stat-label">Warning</div>
          </div>
          <div class="stat-card critical">
            <div class="stat-value">{{ getCriticalCount() }}</div>
            <div class="stat-label">Critical</div>
          </div>
          <div class="stat-card offline">
            <div class="stat-value">{{ getOfflineCount() }}</div>
            <div class="stat-label">Offline</div>
          </div>
          <div class="stat-card total">
            <div class="stat-value">{{ stats.totalTurbines }}</div>
            <div class="stat-label">Total turbines</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Health status distribution</h3>
        <p>Share of turbines by status</p>
        <div class="chart-placeholder">
          <div class="donut-chart" [style.background]="getDonutChartGradient()">
            <div class="chart-center">
              <div class="chart-total">{{ turbines.length }}</div>
              <div class="chart-label">Total</div>
            </div>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-color healthy"></span> Healthy</div>
            <div class="legend-item"><span class="legend-color warning"></span> Warning</div>
            <div class="legend-item"><span class="legend-color critical"></span> Critical</div>
            <div class="legend-item"><span class="legend-color offline"></span> Offline</div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="currentPage === 'turbines'" class="turbines-page">
      <div class="section">
        <h3>Turbine assets</h3>
        <p>Filter by region and farm to find turbines</p>
        <div class="filters">
          <div class="filter-group">
            <label>Region</label>
            <select class="filter-select" [(ngModel)]="turbinesFilters.region" (change)="applyFilters()">
              <option value="">All regions</option>
              <option *ngFor="let region of getRegions()" [value]="region">{{ region }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Farm</label>
            <select class="filter-select" [(ngModel)]="turbinesFilters.farm" (change)="applyFilters()">
              <option value="">All farms</option>
              <option *ngFor="let farm of farms" [value]="farm.name">{{ farm.name }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Status</label>
            <select class="filter-select" [(ngModel)]="turbinesFilters.status" (change)="applyFilters()">
              <option value="">All status</option>
              <option value="ACTIVE">Active</option>
              <option value="INACTIVE">Inactive</option>
              <option value="MAINTENANCE">Maintenance</option>
              <option value="OFFLINE">Offline</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Asset list</h3>
        <p>Turbine metadata for reporting and planning</p>
        <div class="table-container">
          <table class="turbines-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>NAME</th>
                <th>FARM</th>
                <th>REGION</th>
                <th>STATUS</th>
                <th>CAPACITY (MW)</th>
                <th>INSTALLED</th>
                <th>LAST UPDATED</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let turbine of getPaginatedTurbines()">
                <td>{{ turbine.turbineId }}</td>
                <td>{{ turbine.name }}</td>
                <td>{{ turbine.farm?.name || 'N/A' }}</td>
                <td>{{ turbine.farm?.region || 'N/A' }}</td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(turbine.status)">
                    {{ turbine.status }}
                  </span>
                </td>
                <td>{{ turbine.ratedPower }}</td>
                <td>{{ formatDate(turbine.installedDate) }}</td>
                <td>{{ formatDate(turbine.lastUpdated) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination-container" *ngIf="pagination.totalPages > 0">
          <div class="pagination-info">
            <span>Showing {{ (pagination.currentPage * pagination.itemsPerPage) + 1 }} to {{ Math.min((pagination.currentPage + 1) * pagination.itemsPerPage, pagination.totalItems) }} of {{ pagination.totalItems }} turbines</span>
            <select class="pagination-select" [ngModel]="pagination.itemsPerPage" (ngModelChange)="changeItemsPerPage($event)">
              <option value="5">5 per page</option>
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" [disabled]="pagination.currentPage === 0" (click)="goToPage(0)">First</button>
            <button class="pagination-btn" [disabled]="pagination.currentPage === 0" (click)="goToPage(pagination.currentPage - 1)">Previous</button>
            <span class="pagination-page-info">Page {{ pagination.currentPage + 1 }} of {{ pagination.totalPages }}</span>
            <button class="pagination-btn" [disabled]="pagination.currentPage >= pagination.totalPages - 1" (click)="goToPage(pagination.currentPage + 1)">Next</button>
            <button class="pagination-btn" [disabled]="pagination.currentPage >= pagination.totalPages - 1" (click)="goToPage(pagination.totalPages - 1)">Last</button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="currentPage === 'alerts'" class="alerts-page">
      <div class="section">
        <h3>Health Alerts</h3>
        <div class="table-container" *ngIf="alerts.length > 0">
          <table class="alerts-table">
            <thead>
              <tr>
                <th>Turbine ID</th>
                <th>Alert Type</th>
                <th>Severity</th>
                <th>Message</th>
                <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let alert of getPaginatedAlerts()">
                <td>{{ alert.turbine?.turbineId }}</td>
                <td>{{ alert.alertType }}</td>
                <td>
                  <span class="status-badge" [ngClass]="'status-' + alert.severity.toLowerCase()">
                    {{ alert.severity }}
                  </span>
                </td>
                <td>{{ alert.message }}</td>
                <td>{{ formatDate(alert.alertTime) }}</td>
                <td>
                  <button class="btn-small" (click)="resolveAlert(alert.id!)">Resolve</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="pagination-container" *ngIf="alertPagination.totalPages > 0 && alerts.length > 0">
          <div class="pagination-info">
            <span>Showing {{ (alertPagination.currentPage * alertPagination.itemsPerPage) + 1 }} to {{ Math.min((alertPagination.currentPage + 1) * alertPagination.itemsPerPage, alertPagination.totalItems) }} of {{ alertPagination.totalItems }} alerts</span>
            <select class="pagination-select" [ngModel]="alertPagination.itemsPerPage" (ngModelChange)="changeAlertItemsPerPage($event)">
              <option value="5">5 per page</option>
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
            </select>
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" [disabled]="alertPagination.currentPage === 0" (click)="goToAlertPage(0)">First</button>
            <button class="pagination-btn" [disabled]="alertPagination.currentPage === 0" (click)="goToAlertPage(alertPagination.currentPage - 1)">Previous</button>
            <span class="pagination-page-info">Page {{ alertPagination.currentPage + 1 }} of {{ alertPagination.totalPages }}</span>
            <button class="pagination-btn" [disabled]="alertPagination.currentPage >= alertPagination.totalPages - 1" (click)="goToAlertPage(alertPagination.currentPage + 1)">Next</button>
            <button class="pagination-btn" [disabled]="alertPagination.currentPage >= alertPagination.totalPages - 1" (click)="goToAlertPage(alertPagination.totalPages - 1)">Last</button>
          </div>
        </div>
        
        <div *ngIf="alerts.length === 0" class="empty-state">
          <p>No active alerts</p>
        </div>
      </div>
    </div>

    <div *ngIf="currentPage === 'analytics'" class="analytics-page">
      <div class="section">
        <h3>Historical performance</h3>
        <p>Daily generation and efficiency to plan maintenance</p>
        <div class="filters">
          <div class="filter-group">
            <label>Farm</label>
            <select class="filter-select" [(ngModel)]="analyticsFilters.farm" (change)="loadAnalytics()">
              <option value="">All farms</option>
              <option *ngFor="let farm of farms" [value]="farm.name">{{ farm.name }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Period (Days)</label>
            <input type="number" class="filter-select" 
                   [(ngModel)]="analyticsFilters.period" 
                   (change)="loadAnalytics()" 
                   min="1" 
                   max="365" 
                   required
                   placeholder="Days (1-365)">
            <small class="validation-message" *ngIf="isInvalidPeriod()">
              Period must be between 1 and 365 days
            </small>
          </div>
        </div>
      </div>

      <div class="section" *ngIf="graphData.length > 0">
        <h3>Daily generation & efficiency</h3>
        <p>Trends over time</p>
        <div class="analytics-chart">
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-color" style="background: #4caf50;"></span> Total generation (kWh)</div>
            <div class="legend-item"><span class="legend-color" style="background: #2196f3;"></span> Avg efficiency (%)</div>
          </div>
          <div class="chart-container">
            <svg class="line-chart" viewBox="0 0 1000 400" preserveAspectRatio="none">
              <defs>
                <linearGradient id="generationGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#4caf50;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#4caf50;stop-opacity:0.1" />
                </linearGradient>
                <linearGradient id="efficiencyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#2196f3;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#2196f3;stop-opacity:0.1" />
                </linearGradient>
              </defs>
              
              <g class="chart-grid">
                <line *ngFor="let i of [0,1,2,3,4]" 
                      [attr.x1]="0" 
                      [attr.y1]="i * 80 + 20" 
                      [attr.x2]="1000" 
                      [attr.y2]="i * 80 + 20" 
                      stroke="var(--border-color)" 
                      stroke-width="0.5" 
                      stroke-dasharray="2,2" 
                      opacity="0.3"/>
              </g>
              
              <g class="chart-labels">
                <text *ngFor="let i of [0,1,2,3,4]; let idx = index" 
                      [attr.x]="10" 
                      [attr.y]="i * 80 + 25" 
                      fill="var(--text-secondary)" 
                      font-size="12">
                  {{ getGenerationYLabel(idx) }}
                </text>
                <text *ngFor="let i of [0,1,2,3,4]; let idx = index" 
                      [attr.x]="980" 
                      [attr.y]="i * 80 + 25" 
                      fill="var(--text-secondary)" 
                      font-size="12" 
                      text-anchor="end">
                  {{ getEfficiencyYLabel(idx) }}%
                </text>
              </g>
              
              <g class="chart-x-axis">
                <text *ngFor="let data of graphData; let i = index" 
                      [attr.x]="getChartX(i)" 
                      y="380" 
                      fill="var(--text-secondary)" 
                      font-size="10" 
                      text-anchor="middle"
                      [attr.transform]="'rotate(-45, ' + getChartX(i) + ', 380)'">
                  {{ data.date }}
                </text>
              </g>
              
              <path class="line-path generation-line" 
                    [attr.d]="getGenerationPath()" 
                    fill="none" 
                    stroke="#4caf50" 
                    stroke-width="3" 
                    stroke-linecap="round" 
                    stroke-linejoin="round"/>
              
              <path class="area-path generation-area" 
                    [attr.d]="getGenerationAreaPath()" 
                    fill="url(#generationGradient)"/>
              
              <path class="line-path efficiency-line" 
                    [attr.d]="getEfficiencyPath()" 
                    fill="none" 
                    stroke="#2196f3" 
                    stroke-width="3" 
                    stroke-linecap="round" 
                    stroke-linejoin="round"/>
              
              <path class="area-path efficiency-area" 
                    [attr.d]="getEfficiencyAreaPath()" 
                    fill="url(#efficiencyGradient)"/>
              
              <g class="chart-points">
                <ng-container *ngFor="let data of graphData; let i = index">
                  <circle *ngIf="data.generation > 0"
                          [attr.cx]="getChartX(i)" 
                          [attr.cy]="getGenerationY(data.generation)" 
                          r="4" 
                          fill="#4caf50" 
                          stroke="var(--bg-primary)" 
                          stroke-width="2"
                          class="chart-point generation-point"/>
                </ng-container>
                <ng-container *ngFor="let data of graphData; let i = index">
                  <circle *ngIf="data.efficiency > 0"
                          [attr.cx]="getChartX(i)" 
                          [attr.cy]="getEfficiencyY(data.efficiency)" 
                          r="4" 
                          fill="#2196f3" 
                          stroke="var(--bg-primary)" 
                          stroke-width="2"
                          class="chart-point efficiency-point"/>
                </ng-container>
              </g>
            </svg>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Daily metrics</h3>
        <p>Per-farm totals and averages</p>
        <div class="table-container" *ngIf="analyticsData.length > 0">
          <table class="analytics-table">
            <thead>
              <tr>
                <th>DATE</th>
                <th>FARM</th>
                <th>TOTAL GENERATION (KWH)</th>
                <th>AVG EFFICIENCY %</th>
                <th>OPERATING HOURS</th>
                <th>MAX POWER (KW)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of analyticsData">
                <td>{{ data.date }}</td>
                <td>{{ data.farm }}</td>
                <td>{{ data.generation.toFixed(2) }}</td>
                <td>{{ data.efficiency.toFixed(1) }}%</td>
                <td>{{ data.hours.toFixed(1) }}</td>
                <td>{{ data.maxPower.toFixed(2) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="no-data-message" *ngIf="analyticsData.length === 0">
          <p>No data available for the selected period.</p>
          <p class="no-data-hint">Data will appear after telemetry aggregation runs. Aggregation occurs hourly for the previous hour.</p>
        </div>
      </div>

      <div class="section">
        <h3>Summary Report</h3>
        <div class="report-grid">
          <div class="report-card">
            <div class="report-label">Total Turbines</div>
            <div class="report-value">{{ turbines.length }}</div>
          </div>
          <div class="report-card">
            <div class="report-label">Active Turbines</div>
            <div class="report-value">{{ getHealthyCount() }}</div>
          </div>
          <div class="report-card">
            <div class="report-label">Total Farms</div>
            <div class="report-value">{{ farms.length }}</div>
          </div>
          <div class="report-card">
            <div class="report-label">Active Alerts</div>
            <div class="report-value">{{ alerts.length }}</div>
          </div>
          <div class="report-card">
            <div class="report-label">Avg Efficiency</div>
            <div class="report-value">{{ getAvgEfficiency().toFixed(1) }}%</div>
          </div>
          <div class="report-card">
            <div class="report-label">Total Capacity</div>
            <div class="report-value">{{ getTotalCapacity().toFixed(2) }} MW</div>
          </div>
        </div>
      </div>
    </div>

    <div class="loading" *ngIf="loading && currentPage === 'dashboard'">
      <p>Loading...</p>
    </div>

    <div class="error" *ngIf="error && !loading && currentPage === 'dashboard'">
      <p>{{ error }}</p>
      <button class="btn-small" (click)="loadData()" style="margin-top: 10px;">Retry</button>
    </div>
  </div>
</div>
